{% extends 'base.html' %}

{% from "macros.html" import jqgrid_boilerplate with context %}
{% from "macros.html" import settings_ajax_interaction_chain with context %}

{% block pagescripts %}
<script>
var lastsel_tourneys;
$(function () {
  "use strict";
  function tourneySettingsButtonFormatter(cellvalue, options, rowObject)
  {
    // some business logic for each row
    let rslt = "<button class='trny_settings_btn' style='text-align:center;' id='trny_settings_";
    rslt = rslt.concat(cellvalue);
    rslt = rslt.concat("'><img src='static/gear.svg' style='height:18px;'></img></button>");
    return rslt;
    //return "<button class='btn' style='height:22px;'><img src='static/gear.svg' style='height:10px;'></img></button>";
    //return "<input style='height:22px;' class='ui-icon-gear' type='button' value='clickme'/>";
  }
  jQuery("#tourneys_table").jqGrid({
    url:'json/tourneys',
    editurl:'edit/tourneys',
    colNames:['Id', 'Name', 'Owner', 'Group', 'Notes', 'Settings'],
    colModel:[
      {name:'id',index:'id', width:55, sortable:true, sorttype:'integer'},
      {name:'name',index:'name', width:100, editable:true, edittype:'text', sortable:true},
      {name:'owner', index:'owner', width:100, editable:false, sortable:true},
      {name:'group', index:'group', width:100, editable:false, sortable:true},
      {name:'notes', index:'notes', width:100, editable:true, edittype:'textarea', sortable:true},
      {name:'settings', index:'settings', editable:false, width:100, sortable:false, formatter:tourneySettingsButtonFormatter}
    ],
    onSelectRow: function(id){
      if(id && id!==lastsel_tourneys){
	$(this).jqGrid('saveRow', lastsel_tourneys);
	$(this).jqGrid('editRow', id, true);
	lastsel_tourneys=id;
      }
    },
    gridComplete: function() {
      jQuery(".trny_settings_btn").click(function(event) {
	event.stopPropagation();
	let tourney_id = this.id.substr('trny_settings_'.length);
	$.ajax({type:'GET',
		url:'ajax/tourneys/settings',
		data:{'tourney_id':tourney_id}
	       })
	  .fail(function(jqXHR, textStatus, errorThrown) {
	    alert('The server did not respond as expected to the request for data on this tourney.');
	    console.log('failure jqXHR: ', jqXHR);
	    console.log('failure textStatus: ', textStatus);
	    console.log('failure thrown: ', errorThrown)
	  })
	  .done(function(data, textStatus, jqXHR) {
	    if (data['status'] == 'success') {
	      let this_div = $('<div />');
	      this_div.html(data['value']['dlg_html']).dialog({
		buttons: {
		  "Cancel": function() {
		    $(this).dialog("close");
		    this_div.remove();
		  },
		  "Save": function() {
		    let form_data = $('#' + data['value']['form_name']).serializeArray();
		    form_data.push({'name':'tourney_id', 'value':tourney_id});
		    $(this).dialog("close");
		    $.ajax({
		      type:'PUT',
		      url:'ajax/tourneys/settings',
		      data:form_data
		    })
		      .fail(function(jqXHR, textStatus, errorThrown) {
			alert('The server did not respond as expected to the update request for this tourney.');
			console.log('failure jqXHR: ', jqXHR);
			console.log('failure textStatus: ', textStatus);
			console.log('failure thrown: ', errorThrown)
		      })
		      .done(function(data, textStatus, jqXHR) {
			if (data['status'] == 'success') {
			  $("#tourneys_table").trigger('reloadGrid',{ fromServer: true });
			}
			else if (data['status'] == 'confirm') {
			  //alert('confirm clause' + data['msg']);
			  let this_confirm_div = $('<div title="Confirmation Required"/>');
			  this_confirm_div.html(data['msg']).dialog({
			    buttons: {
			      "Cancel": function() {
				$(this).dialog("close");
				this_confirm_div.remove();
			      },
			      "Confirm": function() {
				$(this).dialog("close");
				form_data.push({'name': 'confirm', 'value': 'true'});
				$.ajax({
				  type:'PUT',
				  url:'ajax/tourneys/settings',
				  data:form_data
				})
				  .fail(function(jqXHR, textStatus, errorThrown) {
				    alert('The server did not respond as expected to the update request for this tourney.');
				    console.log('failure jqXHR: ', jqXHR);
				    console.log('failure textStatus: ', textStatus);
				    console.log('failure thrown: ', errorThrown)
				  })
				  .done(function(data, textStatus, jqXHR) {
				    if (data['status'] == 'success') {
				      $("#tourneys_table").trigger('reloadGrid',{ fromServer: true });
				    }
				    else {
				      if (data['msg']) {
					alert(data['msg'])
				      }
				      else {
					alert('The server did not report success in response to the update of tourney data.')
				      }
				      console.log('non-success data:', data)
				    }
				  })
				  .always(function() {
				    this_confirm_div.remove();
				  })
			      }
			    }
			  });
			}
			else {
			  if (data['msg']) {
			    alert(data['msg'])
			  }
			  else {
			    alert('The server did not report success in response to the update of tourney data.')
			  }
			  console.log('non-success data:', data)
			}
		      })
		      .always(function() {
			this_div.remove();
		      })
		  }
		}
	      })
	    }
	    else {
	      if (data['msg']) {
		alert(data['msg'])
	      }
	      else {
		alert('The server did not report success in response to the request for tourney data.')
	      }
	      console.log(data);
	    }
	  })
      });
    },
    sortname: 'id',
    caption:"Tourneys",
    {{ jqgrid_boilerplate() }}
  });
  jQuery("#add_tourney_button").click( function() {
    $("#tourneys_table").jqGrid('editGridRow', "new",
				{closeAfterAdd: true, reloadAfterSubmit: true});
  });
  jQuery("#del_tourney_button").click( function() {
    jQuery("#tourneys_table").jqGrid('delGridRow',lastsel_tourneys,
				     {msg:"Are you sure you want to delete this tournament and all the associated bouts?"});
    lastsel_tourneys=null;
  });
  jQuery("#reload_tourney_button").click( function() {
    $("#tourneys_table").trigger('reloadGrid',{ fromServer: true });
    lastsel_tourneys=null;
  });

  function reload_tables_fun() {
    all_tourneys_table.ajax.reload();
  }
  var all_tourneys_table = $('#all_tourneys_table').DataTable({
    dom: 'Bfrtip',
    select: true,
    ajax: {
      url: '/ajax/tourneys?counts=true',
      dataSrc: 'value'
    },
    columns: [
      {data: 'id'},
      {data: 'name'},
      {data: 'entrants'},
      {data: 'bouts'},
      {data: 'note'},
      {data: null, className: 'editbutton',
       render: function(data, type, row, meta) {
	 return "<button><img src='static/gear.svg'></img></button>";
       }
      }
    ],
    buttons: [
      {
        text: 'New Tourney',
        action: function (evt, dt_api, jq_btn, btn_cfg) {
	  $.ajax({
	    type:'GET',
	    url:'forms/tourneys/create'
	  })
	    .fail(function(jqXHR, textStatus, errorThrown) {
	      alert('The server did not respond as expected to the form request for this tourney.');
	      console.log('failure jqXHR: ', jqXHR);
	      console.log('failure textStatus: ', textStatus);
	      console.log('failure thrown: ', errorThrown)
	    })
	    .done(function(data, textStatus, jqXHR) {
	      let this_div = $('<div />');
	      this_div.html(data).dialog({
		buttons: {
		  "Cancel": function() {
		    $(this).dialog("close");
		    this_div.remove();
		  },
		  "Save": function() {
		    let form_data = this_div.find("form").serializeArray();
		    form_data.push({'name': 'action', 'value': 'create'});
		    $(this).dialog("close");
		    $.ajax({
		      type: 'PUT',
		      url: '/ajax/tourneys',
		      data: form_data
		    })
		      .fail(function(jqXHR, textStatus, errorThrown) {
			alert("The server did not respond as expected to the request to create the tourney.");
			console.log('failure jqXHR: ', jqXHR);
			console.log('failure textStatus: ', textStatus);
			console.log('failure thrown: ', errorThrown)
		      })
		      .done(function(data, textStatus, jqXHR) {
			if (data['status'] == 'success') {
			  reload_tables_fun();
			}
			else {
			  if (data['msg']) {
			    alert(data['msg'])
			  }
			  else {
			    alert("The server did not report success in response to create the tourney.")
			  }
			  console.log('non-success data:', data);
			}
		      })
		      .always(function() {
			this_div.remove();
		      })
		  }
		}
	      });
	    })
	}
      },
      {
        text: 'Delete Selected Tourney',
        action: function (evt, dt_api, jq_btn, btn_cfg) {
	  all_tourneys_table.rows({selected:true}).data().each(
	    function(row, idx) {
	      let confirm_div = $('<div title="Confirmation Required"/>');
	      (confirm_div.html("Completely delete the entire tournament "
				+ row['name'] + "? The entrants will continue"
				+ " to exist but their bouts in this tournament"
				+ " will be forgotten.")
	       .dialog({
		 buttons: {
		   "Cancel": function() {
		     confirm_div.remove();
		   },
		   "Confirm": function() {
		     $(this).dialog("close");
		     $.ajax({
		       type:'PUT',
		       url:'ajax/tourneys',
		       data: {
			 tourney_id: row['id'],
			 action: 'delete',
		       }
		     })
		       .fail(function(jqXHR, textStatus, errorThrown) {
			 alert('The server did not respond as expected to the delete request for this tournament.');
			 console.log('failure jqXHR: ', jqXHR);
			 console.log('failure textStatus: ', textStatus);
			 console.log('failure thrown: ', errorThrown)
		       })
		       .done(function(data, textStatus, jqXHR) {
			 if (data['status'] == 'success') {
			   reload_tables_fun();
			 }
			 else {
			   if (data['msg']) {
			     alert(data['msg'])
			   }
			   else {
			     alert('The server did not report success in response to the deletion of tourney data.')
			   }
			   console.log('non-success data:', data)
			 }
		       })
		       .always(function() {
			 confirm_div.remove();
		       })
		   }
		 }  // closes buttons:
	       }))
	    })  // closes each()
	}
      },
    ]
  });
  function tourney_settings_on_click_fun(event) {
    event.stopPropagation();
    let data = event.data['current_table'].row($(this).parents('tr')).data();
    let tourney_id = data['id'];
    function settings_get_fun() { return {'tourney_id' : tourney_id}; };
    {{ settings_ajax_interaction_chain('/ajax/tourneys/settings',
				       'settings_get_fun',
				       'reload_tables_fun',
				       'this tourney') }}
  };
  $("#all_tourneys_table tbody").on("click", "button",
				       {current_table: all_tourneys_table},
				       tourney_settings_on_click_fun);
});
</script>
{% endblock %}

{% block content %}
<h1>Known Tournaments</h1>

<div id="all_tourneys_block" class="border">
  <table id="all_tourneys_table" class="table table-striped">
    <thead>
      <tr>
	<th>Id</th>
	<th>Name</th>
	<th>Entrants</th>
	<th>Bouts</th>
	<th>Notes</th>
	<th>Edit</th>
      </tr>
    </thead>
  </table>
</div>

<table id="tourneys_table"></table>

<input type="BUTTON" id="add_tourney_button" value="New Tourney">
<input type="BUTTON" id="del_tourney_button" value="Delete Selected Tourney">
<input type="BUTTON" id="reload_tourney_button" value="Reload">
{% endblock %}

